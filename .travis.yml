sudo: true
language: go
go:
- 1.6.2
go_import_path: github.com/vmware/harbor
services:
- docker
dist: trusty
env:
  matrix:
    DB_HOST: 127.0.0.1
    DB_PORT: 3306
    DB_USR: root
    DB_PWD: root123
    MYSQL_HOST: localhost
    MYSQL_PORT: 3306
    MYSQL_USR: root
    MYSQL_PWD: root123
    DOCKER_COMPOSE_VERSION: 1.7.1
    HARBOR_ADMIN: admin
    HARBOR_ADMIN_PASSWD: Harbor12345
    UI_SECRET: tempString
    MAX_JOB_WORKERS: 3
    SECRET_KEY: 1234567890123456
    AUTH_MODE: db_auth
    SELF_REGISTRATION: 'on'
  global:
    secure: dveaew/dC1TTCdD6FHMF9dVX8QL0iO5gxRO21bZGzPSQ6hC7BVZFjUHi1MRd1cTwcUhr9htuZtVYPSFRcdXRmQeIE/bW5dTTpEgTSeyuu6O9gTH1Y0+caMTBZuXpIbqhlHL7e0dRzQwr7729TABxsbeV/+6HNVzNypx6V57wRjPqoi/LMrlLLMMz7Zc/smJkhT5sRQt+A69mzGl1XPlVkKAIc6v7KGhaj5EEiUr1DKKldQ3maiHmdG8FMKFEXpA3U1IJsM3wNioK4Ej0li4kMqOkCm48cJ72ofcEd8bPnt3M0py6GJ9SKN3WUkY4pLeyzRXE9/CLOJhO0TW7MTvrrh9OYPsBNSZLoDNHdVqcPXrx53aS1SmC7D2GwufMeL9e3W5dTu3vxskvliS/oTk2M1i3TgUMqKv9Vs/jvwrYvreP+aO9jU/JAtHqRPdt7tmVKwNGIGUEN4nBw6B5C1X9c/8xA5cmtE6vN27GP3fAc8OrIvDfKq4NPTMeat8Vf25V0NMnV64GbwKAuAEUdcs4XU9DDZrZuqGbldAK1fgismVhM9+jsLp+5javxT625S0XLFhWheUilMTRp8lKNHwGQxraAyZqi3ZUpMd/ThoU2oSb+Cj+Vdk6xL7H/qeRgDHWBxyxk5dOqGU+iFFcZFt++Ebh4rX3Ut9RcmknnZ2SCzw=
before_install:
- sudo ./tests/hostcfg.sh
- cd Deploy
- sudo ./prepare
- cd ..
install:
- sudo apt-get update && sudo apt-get install -y libldap2-dev
- go get -d github.com/docker/distribution
- go get -d github.com/docker/libtrust
- go get -d github.com/go-sql-driver/mysql
- go get github.com/golang/lint/golint
- go get github.com/GeertJohan/fgt
- curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname
  -s`-`uname -m` > docker-compose
- chmod +x docker-compose
- sudo mv docker-compose /usr/local/bin
- IP=`ip addr s eth0 |grep "inet "|awk '{print $2}' |awk -F "/" '{print $1}'`
- sudo sed -i '$a DOCKER_OPTS=\"--insecure-registry '$IP':5000\"' /etc/default/docker
- sudo service docker restart
- go get github.com/dghubble/sling
- go get github.com/stretchr/testify
- go get golang.org/x/tools/cmd/cover
- go get github.com/mattn/goveralls
before_script: 
script:
- sudo ./tests/testprepare.sh
- docker-compose -f Deploy/docker-compose.test.yml up -d
- go list ./... | grep -v -E 'vendor|tests' | xargs -L1 fgt golint
- go list ./... | grep -v -E 'vendor|tests' | xargs -L1 go vet
- export MYSQL_HOST=$IP
- export REGISTRY_URL=$IP:5000
- echo $REGISTRY_URL
- "./tests/pushimage.sh"
- "./Deploy/coverage4gotest.sh"
- docker-compose -f Deploy/docker-compose.test.yml down
- docker-compose -f Deploy/docker-compose.yml up -d
- docker ps
- go run tests/startuptest.go http://localhost/
- go run tests/userlogintest.go -name ${HARBOR_ADMIN} -passwd ${HARBOR_ADMIN_PASSWD}
